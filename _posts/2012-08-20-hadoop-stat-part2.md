---
layout: default
published: true
---

# Hadoop统计平台——MMStat（二）  

## 数据结构

如果直接就把方案写出来，其实理解起来会有种“中国式教育”的味道。所以我还是打算先提出当时遇到的问题。  
如果现在我想统计2012-08-20这一天“美丽说”这个app的iphone平台上2.5.8版本的“最新宝贝”浏览页的PV数和设备数，那么要怎么解决这个问题？很明显我只需要输出当天日志文件的所有内容，然后分别grep：美丽说、iPhone、2.5.8、最新宝贝的浏览请求，最后提取一个日志数还有抽取其中的设备号并去重，那我就可以达到目标。  
  
那如果现在需要的是另一个版本2.5.9的同样的数据呢？好吧，我还是可以输出当天日志再重新grep一把，但问题很快就会升级到需要看各个版本的同一个数据，如果历史有过10个版本，那么同样的日志内容就会被输出10遍，然而真正的问题并不在这里，而是有可能不需要看分版本的数据，需要聚合起来，然而这一次变成要看不同的设备平台的数据，例如iphone、android和ipad；又或者除了不同的设备和不同的版本，PM、RD和leader们还需要看不同的app还有不单只是“最新宝贝”浏览请求的设备和PV，还有别的其他N个请求，说到这里基本上以我的语文水平，可能你已经有点晕，但无论晕还是不晕，该看的，该计算的还是得做出来。  
  
上述的问题其实就是一个维度组合的问题，首先简单说一个概念（我从没学过数据挖掘，如果你学过，相信你马上能理解我说的小玩意啦）：**维度和维度值**。根据上面实际要解决的问题背景，像app、设备平台、版本号、请求类型这些都被我称为维度，而这些维度的具体取值就是维度值。那么上述的问题其实就是根据不同的维度值组合起来进行计算。而MMStat的诞生第一个就是要解决这样一个问题——高效地计算不同维度值组合形成的条件下对应的不同统计项的统计结果（统计项指的就是PV、去重设备等等）。  
  
不知道你首先想到的是不是RDBMS查询，上面的条件不就是where从句里面的各个筛选条件嘛，既然用RDBMS就可以，为什么要专门设计一个系统呢？谈到这个问题就得追溯到我刚接手要负责无线统计时的光景。那时候美丽说的数据组就是用mysql存储解析后的日志，然后在统计计算的python脚本里面写了一大票sql，最后生成的统计结果再写入到mysql供给前段应用查询。其实这样的方案跟我最开始提到的不停输出全部日志内容，然后根据条件grep一把没什么区别，可能就是程序里面枚举各个条件要方便一点而已。然而这样的方案最大的问题就是日志的重复遍历，忘记在哪本经典的算法书（相信我，肯定不是国人写的）上看到过这么大致这么意思的一句话，“如果存在冗余计算，那么就有提升的算法效率的空间”，我一直非常信奉这句话，当然在实际工作上可能针对那一点冗余计算要付出很大的努力，例如设计复杂的存储结构和复杂的算法代码，因此还是得权衡。  
  
在当时的方案中，重复输出日志信息就是冗余计算，而且非常冗余，因为符合每一个维度值组合的条件筛选出来的日志记录其实只会是所有日志记录中的极小一部分，然而为了计算这么一部分的日志而遍历全部日志，是非常不明智的。因此当时刚起步的无线只有大概8G一天的日志，统计的内容也不足现在的1/10，但却每天要计算12个小时——这也是我要接手统计的原因。
